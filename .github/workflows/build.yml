name: Dev Preview (Auto Port Detection)

on:
  workflow_dispatch: # ম্যানুয়ালি রান করার জন্য

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract Zip
        run: |
          ZIP_FILE=$(ls *.zip | head -n 1)
          if [ -f "$ZIP_FILE" ]; then
            unzip -o "$ZIP_FILE" -d .
            rm "$ZIP_FILE"
          fi

      - name: Install Dependencies
        run: npm install

      - name: Detect Port and Start Preview
        run: |
          # Node.js দিয়ে vite config থেকে পোর্ট খুঁজে বের করা
          PORT=$(node -e "
            const fs = require('fs');
            const content = fs.readFileSync('vite.config.js', 'utf8');
            const match = content.match(/port:\s*(\d+)/);
            console.log(match ? match[1] : 5173);
          ")
          echo "Detected Port: $PORT"

          # লকাল টানেল ইনস্টল
          npm install -g localtunnel
          
          # Dev সার্ভার ব্যাকগ্রাউন্ডে রান করা হচ্ছে
          npm run dev -- --host & 
          
          # সার্ভার পুরোপুরি চালু হওয়ার জন্য কিছুটা সময় দেয়া
          sleep 15
          
          # টানেল চালু করা এবং লিঙ্ক দেখানো
          echo "------------------------------------------"
          echo "YOUR PUBLIC PREVIEW LINK BELOW:"
          lt --port $PORT
          echo "------------------------------------------"
